<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte Final de Servicio Social</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
        }

        body {
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.4;
        }

        .container {
            max-width: 210mm;
            margin: 0 auto;
            padding: 20px;
            background: white;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }

        .header {
            text-align: center;
            margin-bottom: 25px;
            border-bottom: 2px solid #1a3a8f;
            padding-bottom: 15px;
        }

        .university {
            font-size: 14px;
            font-weight: bold;
            color: #1a3a8f;
            margin-bottom: 5px;
        }

        .center {
            font-size: 12px;
            font-weight: bold;
            color: #1a3a8f;
            margin-bottom: 5px;
        }

        .unit {
            font-size: 11px;
            color: #1a3a8f;
            margin-bottom: 15px;
        }

        .report-title {
            font-size: 16px;
            font-weight: bold;
            text-transform: uppercase;
            color: #000;
            margin: 15px 0;
        }

        .section {
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 12px;
            font-weight: bold;
            background-color: #e6e6e6;
            padding: 5px 10px;
            margin-bottom: 8px;
            border-left: 4px solid #1a3a8f;
        }

        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .info-item {
            margin-bottom: 8px;
        }

        .info-label {
            font-size: 11px;
            font-weight: bold;
            margin-bottom: 2px;
        }

        .info-value {
            font-size: 11px;
            padding: 3px 0;
            border-bottom: 1px solid #ccc;
            min-height: 20px;
        }

        .content-box {
            border: 1px solid #ccc;
            padding: 10px;
            min-height: 120px;
            margin-bottom: 15px;
            font-size: 11px;
            line-height: 1.4;
        }

        .signature-section {
            margin-top: 40px;
            border-top: 1px solid #000;
            padding-top: 20px;
        }

        .signature-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .signature-box {
            text-align: center;
        }

        .signature-line {
            height: 1px;
            background-color: #000;
            margin: 40px 0 10px;
        }

        .signature-name {
            font-size: 10px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .signature-role {
            font-size: 9px;
            color: #666;
            margin-bottom: 5px;
        }

        .signature-instruction {
            font-size: 8px;
            color: #888;
            font-style: italic;
        }

        .date-table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }

        .date-table td {
            border: 1px solid #000;
            padding: 5px;
            text-align: center;
            font-size: 10px;
            width: 33.33%;
        }

        .note {
            font-size: 9px;
            color: #666;
            text-align: justify;
            margin-top: 20px;
            padding: 10px;
            background-color: #f9f9f9;
            border-left: 3px solid #ff6b6b;
        }

        .page-break {
            page-break-before: always;
            margin-top: 40px;
        }

        .no-print {
            text-align: center;
            margin: 20px 0;
            padding: 20px;
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            margin: 0 10px;
        }

        .btn-print {
            background-color: #1a3a8f;
            color: white;
        }

        .btn-save {
            background-color: #28a745;
            color: white;
        }

        .btn-back {
            background-color: #6c757d;
            color: white;
        }

        .info-cards {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .info-card {
            background: #f8f9fa;
            border: 2px solid #1a3a8f;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .info-card h3 {
            color: #1a3a8f;
            margin-bottom: 15px;
            font-size: 1.2rem;
            border-bottom: 2px solid #1a3a8f;
            padding-bottom: 8px;
        }

        .info-item-card {
            margin-bottom: 8px;
            display: flex;
        }

        .info-label-card {
            font-weight: bold;
            color: #333;
            min-width: 120px;
            font-size: 0.9rem;
        }

        .info-value-card {
            color: #666;
            flex: 1;
            font-size: 0.9rem;
        }

        .form-actions {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
        }

        @media print {
            .no-print {
                display: none;
            }
            
            .container {
                box-shadow: none;
                padding: 15mm;
            }
            
            body {
                background: white;
            }
            
            .info-cards {
                display: none;
            }
        }

        @media (max-width: 768px) {
            .info-cards {
                grid-template-columns: 1fr;
            }
            
            .signature-grid {
                grid-template-columns: 1fr;
            }
            
            .info-grid {
                grid-template-columns: 1fr;
            }
        }

        textarea {
            width: 100%;
            border: 1px solid #ccc;
            padding: 8px;
            font-size: 11px;
            resize: vertical;
            min-height: 100px;
            font-family: Arial, sans-serif;
        }

        input, select {
            width: 100%;
            border: 1px solid #ccc;
            padding: 5px;
            font-size: 11px;
            background: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <form id="finalReportForm">
            <!-- Recuadros informativos -->
            <div class="info-cards no-print">
                <div class="info-card">
                    <h3>👤 Información del Prestador</h3>
                    <div class="info-item-card">
                        <span class="info-label-card">Nombre:</span>
                        <span class="info-value-card" id="prestadorNombre">Cargando...</span>
                    </div>
                    <div class="info-item-card">
                        <span class="info-label-card">Código UDG:</span>
                        <span class="info-value-card" id="prestadorCodigo">Cargando...</span>
                    </div>
                    <div class="info-item-card">
                        <span class="info-label-card">Carrera:</span>
                        <span class="info-value-card" id="prestadorCarrera">Cargando...</span>
                    </div>
                    <div class="info-item-card">
                        <span class="info-label-card">Semestre:</span>
                        <span class="info-value-card" id="prestadorSemestre">Cargando...</span>
                    </div>
                    <div class="info-item-card">
                        <span class="info-label-card">Estado:</span>
                        <span class="info-value-card" id="prestadorEstado">Cargando...</span>
                    </div>
                </div>

                <div class="info-card">
                    <h3>🏢 Información de la Dependencia</h3>
                    <div class="info-item-card">
                        <span class="info-label-card">Organización:</span>
                        <span class="info-value-card" id="dependenciaOrganizacion">Cargando...</span>
                    </div>
                    <div class="info-item-card">
                        <span class="info-label-card">Departamento:</span>
                        <span class="info-value-card" id="dependenciaDepartamento">Cargando...</span>
                    </div>
                    <div class="info-item-card">
                        <span class="info-label-card">Plaza:</span>
                        <span class="info-value-card" id="dependenciaPlaza">Cargando...</span>
                    </div>
                    <div class="info-item-card">
                        <span class="info-label-card">Receptor:</span>
                        <span class="info-value-card" id="dependenciaReceptor">Cargando...</span>
                    </div>
                    <div class="info-item-card">
                        <span class="info-label-card">Horas Totales:</span>
                        <span class="info-value-card" id="dependenciaHoras">Cargando...</span>
                    </div>
                </div>
            </div>

            <!-- Primera página -->
            <div class="header">
                <div class="university">UNIVERSIDAD DE GUADALAJARA</div>
                <div class="center">CENTRO UNIVERSITARIO DE LA CIÉNEGA</div>
                <div class="unit">UNIDAD DE SERVICIO SOCIAL</div>
                <div class="report-title">REPORTE FINAL DE ACTIVIDADES</div>
            </div>

            <!-- Información de la plaza -->
            <div class="section">
                <div class="section-title">PLAZA</div>
                <div class="info-grid">
                    <div class="info-item">
                        <div class="info-label">Alumno:</div>
                        <input type="text" class="info-value" id="studentInfo" placeholder="Ingrese código y nombre completo" required>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Carrera:</div>
                        <input type="text" class="info-value" id="career" placeholder="Ingrese carrera" required>
                    </div>
                </div>
            </div>

            <!-- Información administrativa -->
            <div class="section">
                <div class="info-grid">
                    <div class="info-item">
                        <div class="info-label">Oficio comisión:</div>
                        <input type="text" class="info-value" id="commissionDocument" placeholder="Ingrese oficio de comisión" required>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Turno:</div>
                        <input type="text" class="info-value" id="shift" placeholder="Ingrese turno" required>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Programa:</div>
                        <input type="text" class="info-value" id="program" placeholder="Ingrese programa" required>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Dependencia:</div>
                        <input type="text" class="info-value" id="dependency" placeholder="Ingrese dependencia" required>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Titular:</div>
                        <input type="text" class="info-value" id="head" placeholder="Ingrese nombre del titular" required>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Receptor:</div>
                        <input type="text" class="info-value" id="receptor" placeholder="Ingrese nombre del receptor" required>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Calendario en que inició el Servicio Social:</div>
                        <input type="text" class="info-value" id="calendar" placeholder="Ej: 2024B" required>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Fecha de inicio:</div>
                        <input type="text" class="info-value" id="startDate" placeholder="Ej: 02 de Septiembre del 2024" required>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Fecha de termino:</div>
                        <input type="text" class="info-value" id="endDate" placeholder="Ej: 03 de Marzo del 2025" required>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Horas reportadas:</div>
                        <input type="text" class="info-value" id="hoursReported" placeholder="Ej: 480 hrs." required>
                    </div>
                </div>
            </div>

            <!-- Objetivos del programa -->
            <div class="section">
                <div class="section-title">OBJETIVOS DEL PROGRAMA</div>
                <textarea id="objectives" placeholder="Describa los objetivos del programa..." required></textarea>
            </div>

            <!-- Actividades realizadas -->
            <div class="section">
                <div class="section-title">ACTIVIDADES REALIZADAS</div>
                <textarea id="activities" placeholder="Describa las actividades realizadas durante el servicio social..." required></textarea>
            </div>

            <!-- Metas alcanzadas -->
            <div class="section">
                <div class="section-title">METAS ALCANZADAS</div>
                <textarea id="goals" placeholder="Describa las metas alcanzadas..." required></textarea>
            </div>

            <!-- Metodología utilizada -->
            <div class="section">
                <div class="section-title">METODOLOGÍA UTILIZADA</div>
                <textarea id="methodology" placeholder="Describa la metodología utilizada..." required></textarea>
            </div>

            <!-- Conclusiones y propuestas -->
            <div class="section">
                <div class="section-title">CONCLUSIONES Y PROPUESTAS</div>
                <textarea id="conclusions" placeholder="Describa las conclusiones y propuestas..." required></textarea>
            </div>

            <!-- Aporte de innovaciones -->
            <div class="section">
                <div class="section-title">APORTE DE INNOVACIONES</div>
                <textarea id="innovations" placeholder="Describa los aportes e innovaciones..." required></textarea>
            </div>

            <!-- Firmas primera página -->
            <div class="signature-section">
                <div class="signature-grid">
                    <div class="signature-box">
                        <div class="signature-name" id="headName">TITULAR DE LA DEPENDENCIA</div>
                        <div class="signature-role">(Sello y firma de la dependencia)</div>
                        <div class="signature-line"></div>
                        <div class="signature-instruction">SELLO Y FIRMA DE LA DEPENDENCIA</div>
                    </div>
                    <div class="signature-box">
                        <div class="signature-name">Fecha en que se recibe</div>
                        <table class="date-table">
                            <tr>
                                <td>Dia</td>
                                <td>Mes</td>
                                <td>Año</td>
                            </tr>
                            <tr>
                                <td>&nbsp;</td>
                                <td>&nbsp;</td>
                                <td>&nbsp;</td>
                            </tr>
                        </table>
                    </div>
                    <div class="signature-box">
                        <div class="signature-name">Jefe de Unidad de Servicio Social</div>
                        <div class="signature-line"></div>
                        <div class="signature-instruction">FIRMA</div>
                    </div>
                </div>
            </div>

            <div class="note">
                Nota: una vez que recabes la firma y sello de tu dependencia receptora deberás entregar el informe final en la unidad de servicio social de tu centro. Si perteneces al Sistema de Universidad Virtual la entrega será vía electrónica.
            </div>

            <!-- Segunda página -->
            <div class="page-break">
                <div class="header">
                    <div class="university">UNIVERSIDAD DE GUADALAJARA</div>
                    <div class="center">CENTRO UNIVERSITARIO DE LA CIÉNEGA</div>
                    <div class="unit">UNIDAD DE SERVICIO SOCIAL</div>
                    <div class="report-title">REPORTE FINAL DE ACTIVIDADES</div>
                </div>

                <!-- Información repetida en segunda página -->
                <div class="section">
                    <div class="section-title">PLAZA</div>
                    <div class="info-grid">
                        <div class="info-item">
                            <div class="info-label">Alumno:</div>
                            <div class="info-value" id="studentInfo2"></div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Carrera:</div>
                            <div class="info-value" id="career2"></div>
                        </div>
                    </div>
                </div>

                <div class="section">
                    <div class="info-grid">
                        <div class="info-item">
                            <div class="info-label">Oficio comisión:</div>
                            <div class="info-value" id="commissionDocument2"></div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Turno:</div>
                            <div class="info-value" id="shift2"></div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Programa:</div>
                            <div class="info-value" id="program2"></div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Dependencia:</div>
                            <div class="info-value" id="dependency2"></div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Titular:</div>
                            <div class="info-value" id="head2"></div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Receptor:</div>
                            <div class="info-value" id="receptor2"></div>
                        </div>
                    </div>
                </div>

                <!-- Firmas segunda página -->
                <div class="signature-section">
                    <div class="signature-grid">
                        <div class="signature-box">
                            <div class="signature-name" id="headName2">TITULAR DE LA DEPENDENCIA</div>
                            <div class="signature-role">(Sello y firma de la dependencia)</div>
                            <div class="signature-line"></div>
                            <div class="signature-instruction">SELLO Y FIRMA DE LA DEPENDENCIA</div>
                        </div>
                        <div class="signature-box">
                            <div class="signature-name">Fecha en que se recibe</div>
                            <table class="date-table">
                                <tr>
                                    <td>Dia</td>
                                    <td>Mes</td>
                                    <td>Año</td>
                                </tr>
                                <tr>
                                    <td>&nbsp;</td>
                                    <td>&nbsp;</td>
                                    <td>&nbsp;</td>
                                </tr>
                            </table>
                        </div>
                        <div class="signature-box">
                            <div class="signature-name">Jefe de Unidad de Servicio Social</div>
                            <div class="signature-line"></div>
                            <div class="signature-instruction">FIRMA</div>
                        </div>
                    </div>
                </div>

                <!-- Firma del alumno en segunda página -->
                <div class="signature-section">
                    <div class="signature-box" style="width: 200px; margin: 0 auto;">
                        <div class="signature-name" id="studentName">PRESTADOR DE SERVICIO SOCIAL</div>
                        <div class="signature-role">(Firma del estudiante)</div>
                        <div class="signature-line"></div>
                        <div class="signature-instruction">FIRMA</div>
                    </div>
                </div>

                <div class="note">
                    Nota: una vez que recabes la firma y sello de tu dependencia receptora deberás entregar el informe final en la unidad de servicio social de tu centro. Si perteneces al Sistema de Universidad Virtual la entrega será vía electrónica.
                </div>
            </div>

            <!-- Botones de acción -->
            <div class="no-print">
                <div class="form-actions">
                    <button type="button" class="btn btn-back" onclick="goBack()">Volver</button>
                    <button type="button" class="btn btn-save" onclick="saveReport()">Guardar Reporte</button>
                    <button type="button" class="btn btn-print" onclick="generatePDF()">Generar PDF</button>
                </div>
            </div>
        </form>
    </div>

    <!-- Incluir jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script>
        let usuario = null;
        let asignacion = null;
        let prestadorInfo = null;
        let dependenciaInfo = null;

        document.addEventListener('DOMContentLoaded', function() {
            usuario = JSON.parse(localStorage.getItem('usuario'));
            if (!usuario) {
                window.location.href = 'login.html';
                return;
            }

            loadUserInfo();
            loadAsignacionInfo();
            checkFinalReportEligibility();
            setupFieldSync();
            loadPrestadorInfo();
        });

        function loadUserInfo() {
            document.getElementById('studentInfo').value = `${usuario.codigo_udg} - ${usuario.nombre} ${usuario.apellido_paterno} ${usuario.apellido_materno || ''}`;
            document.getElementById('career').value = usuario.carrera || '';
            document.getElementById('studentName').textContent = `${usuario.nombre} ${usuario.apellido_paterno} ${usuario.apellido_materno || ''}`;
        }

        async function loadPrestadorInfo() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`http://localhost:3000/perfil/${usuario.codigo_udg}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                
                if (data.status === 'ok') {
                    prestadorInfo = data.perfil;
                    updatePrestadorInfo();
                }
            } catch (error) {
                console.error('Error cargando información del prestador:', error);
            }
        }

        function updatePrestadorInfo() {
            if (prestadorInfo) {
                document.getElementById('prestadorNombre').textContent = 
                    `${prestadorInfo.nombre} ${prestadorInfo.apellido_paterno} ${prestadorInfo.apellido_materno || ''}`;
                document.getElementById('prestadorCodigo').textContent = prestadorInfo.codigo_udg;
                document.getElementById('prestadorCarrera').textContent = prestadorInfo.carrera || 'No especificada';
                document.getElementById('prestadorSemestre').textContent = prestadorInfo.semestre || 'No especificado';
                
                const porcentaje = prestadorInfo.porcentaje_creditos || 0;
                let estado = 'Regular';
                if (porcentaje >= 70) estado = 'Avanzado';
                if (porcentaje >= 85) estado = 'Próximo a egresar';
                document.getElementById('prestadorEstado').textContent = estado;
            }
        }

       // En la función loadAsignacionInfo de ambos archivos, mejorar la obtención del nombre del receptor
async function loadAsignacionInfo() {
    try {
        const token = localStorage.getItem('token');
        const response = await fetch('http://localhost:3000/asignacion-activa', {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        const data = await response.json();
        
        if (data.status === 'ok' && data.asignacion) {
            asignacion = data.asignacion;
            dependenciaInfo = data.asignacion;
            updateDependenciaInfo();
            
            // Obtener nombre completo del receptor
            const receptorNombreCompleto = 
                `${asignacion.receptor_nombre || ''} ${asignacion.receptor_apellido_paterno || ''} ${asignacion.receptor_apellido_materno || ''}`.trim();
            
            document.getElementById('receptorSignature').textContent = receptorNombreCompleto || 'No especificado';
            document.getElementById('coordinatorSignature').textContent = 'Coordinador de Servicio Social';
            
            // Actualizar también en los recuadros informativos
            document.getElementById('dependenciaReceptor').textContent = receptorNombreCompleto || 'No especificado';
            
        } else {
            document.getElementById('dependenciaOrganizacion').textContent = 'Sin asignación activa';
            document.getElementById('dependenciaDepartamento').textContent = 'N/A';
            document.getElementById('dependenciaPlaza').textContent = 'N/A';
            document.getElementById('dependenciaReceptor').textContent = 'N/A';
            document.getElementById('dependenciaHoras').textContent = 'N/A';
        }
    } catch (error) {
        console.error('Error cargando información de asignación:', error);
    }
}

        function updateDependenciaInfo() {
            if (dependenciaInfo) {
                document.getElementById('dependenciaOrganizacion').textContent = dependenciaInfo.organizacion || 'No especificada';
                document.getElementById('dependenciaDepartamento').textContent = dependenciaInfo.departamento || 'No especificado';
                document.getElementById('dependenciaPlaza').textContent = dependenciaInfo.plaza_titulo || 'No especificada';
                document.getElementById('dependenciaReceptor').textContent = dependenciaInfo.receptor_nombre || 'No especificado';
                document.getElementById('dependenciaHoras').textContent = 
                    `${dependenciaInfo.horas_acumuladas || 0} / ${dependenciaInfo.horas_requeridas || 480} horas`;
            }
        }

        function formatDate(date) {
            const options = { day: '2-digit', month: 'long', year: 'numeric' };
            return date.toLocaleDateString('es-ES', options);
        }

        async function checkFinalReportEligibility() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`http://localhost:3000/estadisticas/${usuario.codigo_udg}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                
                if (data.status === 'ok') {
                    const stats = data.estadisticas;
                    
                    if (stats.horas_acumuladas < stats.horas_requeridas) {
                        alert(`No puedes generar el reporte final. Te faltan ${stats.horas_requeridas - stats.horas_acumuladas} horas por completar.`);
                        window.location.href = 'crear_reporte.html';
                    }
                }
            } catch (error) {
                console.error('Error verificando elegibilidad:', error);
            }
        }

        function setupFieldSync() {
            const fieldsToSync = [
                'studentInfo', 'career', 'commissionDocument', 'shift', 'program', 
                'dependency', 'head', 'receptor', 'calendar', 'startDate', 'endDate', 'hoursReported'
            ];

            fieldsToSync.forEach(field => {
                const input = document.getElementById(field);
                if (input) {
                    input.addEventListener('input', function() {
                        const secondPageField = document.getElementById(field + '2');
                        if (secondPageField) {
                            secondPageField.textContent = this.value;
                        }
                    });
                }
            });

            const headName = document.getElementById('head');
            if (headName) {
                headName.addEventListener('input', function() {
                    document.getElementById('headName').textContent = this.value;
                    document.getElementById('headName2').textContent = this.value;
                });
            }

            const studentInfo = document.getElementById('studentInfo');
            if (studentInfo) {
                studentInfo.addEventListener('input', function() {
                    const name = this.value.split(' - ')[1] || this.value;
                    document.getElementById('studentName').textContent = name;
                });
            }
        }

        function updateSecondPage() {
            const fieldsToUpdate = [
                'studentInfo', 'career', 'commissionDocument', 'shift', 'program', 
                'dependency', 'head', 'receptor'
            ];

            fieldsToUpdate.forEach(field => {
                const input = document.getElementById(field);
                const display = document.getElementById(field + '2');
                if (input && display) {
                    display.textContent = input.value;
                }
            });

            document.getElementById('headName').textContent = document.getElementById('head').value || 'TITULAR DE LA DEPENDENCIA';
            document.getElementById('headName2').textContent = document.getElementById('head').value || 'TITULAR DE LA DEPENDENCIA';
            
            const studentFullInfo = document.getElementById('studentInfo').value;
            const studentName = studentFullInfo.split(' - ')[1] || studentFullInfo;
            document.getElementById('studentName').textContent = studentName;
        }

        function validateForm() {
            const requiredFields = document.querySelectorAll('input[required], textarea[required]');
            for (let field of requiredFields) {
                if (!field.value.trim()) {
                    alert('Por favor, complete todos los campos obligatorios.');
                    return false;
                }
            }
            return true;
        }

        async function saveReport() {
            if (!validateForm()) return;

            const formData = {
                studentInfo: document.getElementById('studentInfo').value,
                career: document.getElementById('career').value,
                commissionDocument: document.getElementById('commissionDocument').value,
                shift: document.getElementById('shift').value,
                program: document.getElementById('program').value,
                dependency: document.getElementById('dependency').value,
                head: document.getElementById('head').value,
                receptor: document.getElementById('receptor').value,
                calendar: document.getElementById('calendar').value,
                startDate: document.getElementById('startDate').value,
                endDate: document.getElementById('endDate').value,
                hoursReported: document.getElementById('hoursReported').value,
                objectives: document.getElementById('objectives').value,
                activities: document.getElementById('activities').value,
                goals: document.getElementById('goals').value,
                methodology: document.getElementById('methodology').value,
                conclusions: document.getElementById('conclusions').value,
                innovations: document.getElementById('innovations').value
            };

            try {
                const token = localStorage.getItem('token');
                const response = await fetch('http://localhost:3000/reportes/final', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();
                
                if (result.status === 'ok') {
                    alert('Reporte final guardado exitosamente. El servicio social ha sido marcado como concluido.');
                    window.location.href = 'mis_reportes.html';
                } else {
                    alert('Error: ' + result.message);
                }
            } catch (error) {
                console.error('Error guardando reporte final:', error);
                alert('Error al guardar el reporte final. Intente nuevamente.');
            }
        }

       // Reemplazar la función generatePDF en crear_reporte_final.html
function generatePDF() {
    if (!validateForm()) {
        alert('Por favor, complete todos los campos obligatorios antes de generar el PDF.');
        return;
    }

    updateSecondPage();

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    const margin = 15;
    let yPosition = margin;
    const pageWidth = doc.internal.pageSize.width;
    
    // Primera página - Encabezado
    doc.setFontSize(14);
    doc.setFont(undefined, 'bold');
    doc.text('UNIVERSIDAD DE GUADALAJARA', pageWidth / 2, yPosition, { align: 'center' });
    yPosition += 6;
    doc.setFontSize(12);
    doc.text('CENTRO UNIVERSITARIO DE LA CIÉNEGA', pageWidth / 2, yPosition, { align: 'center' });
    yPosition += 6;
    doc.text('UNIDAD DE SERVICIO SOCIAL', pageWidth / 2, yPosition, { align: 'center' });
    yPosition += 10;
    
    doc.setFontSize(16);
    doc.text('REPORTE FINAL DE ACTIVIDADES', pageWidth / 2, yPosition, { align: 'center' });
    yPosition += 15;
    
    // Sección PLAZA
    doc.setFontSize(12);
    doc.setFont(undefined, 'bold');
    doc.text('PLAZA', margin, yPosition);
    yPosition += 8;
    
    doc.setFontSize(10);
    doc.setFont(undefined, 'normal');
    doc.text(`Alumno: ${document.getElementById('studentInfo').value}`, margin, yPosition);
    yPosition += 6;
    doc.text(`Carrera: ${document.getElementById('career').value}`, margin, yPosition);
    yPosition += 10;
    
    // Información administrativa
    const infoData = [
        { label: 'Oficio comisión:', value: document.getElementById('commissionDocument').value },
        { label: 'Turno:', value: document.getElementById('shift').value },
        { label: 'Programa:', value: document.getElementById('program').value },
        { label: 'Dependencia:', value: document.getElementById('dependency').value },
        { label: 'Titular:', value: document.getElementById('head').value },
        { label: 'Receptor:', value: document.getElementById('receptor').value },
        { label: 'Calendario:', value: document.getElementById('calendar').value },
        { label: 'Fecha de inicio:', value: document.getElementById('startDate').value },
        { label: 'Fecha de término:', value: document.getElementById('endDate').value },
        { label: 'Horas reportadas:', value: document.getElementById('hoursReported').value }
    ];
    
    infoData.forEach(item => {
        if (yPosition > 250) {
            doc.addPage();
            yPosition = margin;
        }
        doc.text(`${item.label} ${item.value}`, margin, yPosition);
        yPosition += 6;
    });
    yPosition += 10;
    
    // Objetivos del programa
    if (yPosition > 220) {
        doc.addPage();
        yPosition = margin;
    }
    
    doc.setFontSize(12);
    doc.setFont(undefined, 'bold');
    doc.text('OBJETIVOS DEL PROGRAMA', margin, yPosition);
    yPosition += 8;
    
    doc.setFontSize(10);
    doc.setFont(undefined, 'normal');
    const objectives = doc.splitTextToSize(document.getElementById('objectives').value, 180);
    objectives.forEach(line => {
        if (yPosition > 270) {
            doc.addPage();
            yPosition = margin;
        }
        doc.text(line, margin, yPosition);
        yPosition += 6;
    });
    yPosition += 10;
    
    // Actividades realizadas
    if (yPosition > 220) {
        doc.addPage();
        yPosition = margin;
    }
    
    doc.setFontSize(12);
    doc.setFont(undefined, 'bold');
    doc.text('ACTIVIDADES REALIZADAS', margin, yPosition);
    yPosition += 8;
    
    doc.setFontSize(10);
    doc.setFont(undefined, 'normal');
    const activities = doc.splitTextToSize(document.getElementById('activities').value, 180);
    activities.forEach(line => {
        if (yPosition > 270) {
            doc.addPage();
            yPosition = margin;
        }
        doc.text(line, margin, yPosition);
        yPosition += 6;
    });
    yPosition += 10;
    
    // Metas alcanzadas
    if (yPosition > 220) {
        doc.addPage();
        yPosition = margin;
    }
    
    doc.setFontSize(12);
    doc.setFont(undefined, 'bold');
    doc.text('METAS ALCANZADAS', margin, yPosition);
    yPosition += 8;
    
    doc.setFontSize(10);
    doc.setFont(undefined, 'normal');
    const goals = doc.splitTextToSize(document.getElementById('goals').value, 180);
    goals.forEach(line => {
        if (yPosition > 270) {
            doc.addPage();
            yPosition = margin;
        }
        doc.text(line, margin, yPosition);
        yPosition += 6;
    });
    yPosition += 10;
    
    // Metodología utilizada
    if (yPosition > 220) {
        doc.addPage();
        yPosition = margin;
    }
    
    doc.setFontSize(12);
    doc.setFont(undefined, 'bold');
    doc.text('METODOLOGÍA UTILIZADA', margin, yPosition);
    yPosition += 8;
    
    doc.setFontSize(10);
    doc.setFont(undefined, 'normal');
    const methodology = doc.splitTextToSize(document.getElementById('methodology').value, 180);
    methodology.forEach(line => {
        if (yPosition > 270) {
            doc.addPage();
            yPosition = margin;
        }
        doc.text(line, margin, yPosition);
        yPosition += 6;
    });
    yPosition += 10;
    
    // Conclusiones y propuestas
    if (yPosition > 220) {
        doc.addPage();
        yPosition = margin;
    }
    
    doc.setFontSize(12);
    doc.setFont(undefined, 'bold');
    doc.text('CONCLUSIONES Y PROPUESTAS', margin, yPosition);
    yPosition += 8;
    
    doc.setFontSize(10);
    doc.setFont(undefined, 'normal');
    const conclusions = doc.splitTextToSize(document.getElementById('conclusions').value, 180);
    conclusions.forEach(line => {
        if (yPosition > 270) {
            doc.addPage();
            yPosition = margin;
        }
        doc.text(line, margin, yPosition);
        yPosition += 6;
    });
    yPosition += 10;
    
    // Aporte de innovaciones
    if (yPosition > 220) {
        doc.addPage();
        yPosition = margin;
    }
    
    doc.setFontSize(12);
    doc.setFont(undefined, 'bold');
    doc.text('APORTE DE INNOVACIONES', margin, yPosition);
    yPosition += 8;
    
    doc.setFontSize(10);
    doc.setFont(undefined, 'normal');
    const innovations = doc.splitTextToSize(document.getElementById('innovations').value, 180);
    innovations.forEach(line => {
        if (yPosition > 270) {
            doc.addPage();
            yPosition = margin;
        }
        doc.text(line, margin, yPosition);
        yPosition += 6;
    });
    yPosition += 15;
    
    // Firmas primera página
    if (yPosition > 180) {
        doc.addPage();
        yPosition = margin;
    }
    
    doc.setFontSize(11);
    doc.setFont(undefined, 'bold');
    doc.text('VALIDACIÓN DEL REPORTE', pageWidth / 2, yPosition, { align: 'center' });
    yPosition += 15;
    
    // Firma titular
    doc.setFontSize(9);
    doc.setFont(undefined, 'bold');
    doc.text(document.getElementById('head').value || 'TITULAR DE LA DEPENDENCIA', margin, yPosition);
    yPosition += 4;
    doc.setFont(undefined, 'normal');
    doc.text('(Sello y firma de la dependencia)', margin, yPosition);
    yPosition += 10;
    doc.line(margin, yPosition, margin + 50, yPosition);
    yPosition += 8;
    doc.setFontSize(8);
    doc.text('SELLO Y FIRMA DE LA DEPENDENCIA', margin, yPosition);
    yPosition += 20;
    
    // Fecha
    doc.setFontSize(9);
    doc.setFont(undefined, 'bold');
    doc.text('FECHA EN QUE SE RECIBE', pageWidth / 2 - 25, yPosition);
    yPosition += 10;
    doc.setFont(undefined, 'normal');
    doc.line(pageWidth / 2 - 25, yPosition, pageWidth / 2 + 25, yPosition);
    yPosition += 5;
    doc.text('Día', pageWidth / 2 - 20, yPosition);
    doc.text('Mes', pageWidth / 2, yPosition);
    doc.text('Año', pageWidth / 2 + 20, yPosition);
    yPosition += 20;
    
    // Firma coordinador
    doc.setFontSize(9);
    doc.setFont(undefined, 'bold');
    doc.text('JEFE DE UNIDAD DE SERVICIO SOCIAL', pageWidth - 60, yPosition);
    yPosition += 10;
    doc.line(pageWidth - 60, yPosition, pageWidth - 10, yPosition);
    yPosition += 8;
    doc.setFontSize(8);
    doc.text('FIRMA', pageWidth - 60, yPosition);
    
    // Segunda página para firmas adicionales
    doc.addPage();
    yPosition = margin;
    
    // Encabezado segunda página
    doc.setFontSize(14);
    doc.setFont(undefined, 'bold');
    doc.text('UNIVERSIDAD DE GUADALAJARA', pageWidth / 2, yPosition, { align: 'center' });
    yPosition += 6;
    doc.setFontSize(12);
    doc.text('CENTRO UNIVERSITARIO DE LA CIÉNEGA', pageWidth / 2, yPosition, { align: 'center' });
    yPosition += 6;
    doc.text('UNIDAD DE SERVICIO SOCIAL', pageWidth / 2, yPosition, { align: 'center' });
    yPosition += 10;
    
    doc.setFontSize(16);
    doc.text('REPORTE FINAL DE ACTIVIDADES', pageWidth / 2, yPosition, { align: 'center' });
    yPosition += 20;
    
    // Información resumida segunda página
    doc.setFontSize(10);
    doc.setFont(undefined, 'normal');
    doc.text(`Alumno: ${document.getElementById('studentInfo').value}`, margin, yPosition);
    yPosition += 6;
    doc.text(`Carrera: ${document.getElementById('career').value}`, margin, yPosition);
    yPosition += 6;
    doc.text(`Programa: ${document.getElementById('program').value}`, margin, yPosition);
    yPosition += 6;
    doc.text(`Dependencia: ${document.getElementById('dependency').value}`, margin, yPosition);
    yPosition += 15;
    
    // Firmas segunda página
    doc.setFontSize(11);
    doc.setFont(undefined, 'bold');
    doc.text('VALIDACIÓN DEL REPORTE', pageWidth / 2, yPosition, { align: 'center' });
    yPosition += 20;
    
    // Repetir firmas
    doc.setFontSize(9);
    doc.setFont(undefined, 'bold');
    doc.text(document.getElementById('head').value || 'TITULAR DE LA DEPENDENCIA', margin, yPosition);
    yPosition += 4;
    doc.setFont(undefined, 'normal');
    doc.text('(Sello y firma de la dependencia)', margin, yPosition);
    yPosition += 10;
    doc.line(margin, yPosition, margin + 50, yPosition);
    yPosition += 8;
    doc.setFontSize(8);
    doc.text('SELLO Y FIRMA DE LA DEPENDENCIA', margin, yPosition);
    yPosition += 20;
    
    // Firma del estudiante
    doc.setFontSize(9);
    doc.setFont(undefined, 'bold');
    const studentName = document.getElementById('studentInfo').value.split(' - ')[1] || document.getElementById('studentInfo').value;
    doc.text(studentName, pageWidth / 2, yPosition, { align: 'center' });
    yPosition += 4;
    doc.setFont(undefined, 'normal');
    doc.text('PRESTADOR DE SERVICIO SOCIAL', pageWidth / 2, yPosition, { align: 'center' });
    yPosition += 4;
    doc.text('(Firma del estudiante)', pageWidth / 2, yPosition, { align: 'center' });
    yPosition += 10;
    doc.line(pageWidth / 2 - 25, yPosition, pageWidth / 2 + 25, yPosition);
    yPosition += 8;
    doc.setFontSize(8);
    doc.text('FIRMA', pageWidth / 2, yPosition, { align: 'center' });
    
    // Guardar PDF
    doc.save(`reporte_final_${usuario.codigo_udg}_${new Date().toISOString().split('T')[0]}.pdf`);
}

        function goBack() {
            window.location.href = 'crear_reporte.html';
        }

        // Agregar esta función auxiliar para manejar saltos de página automáticos
function addTextWithPageBreaks(doc, text, x, y, maxWidth, lineHeight = 6) {
    const lines = doc.splitTextToSize(text, maxWidth);
    let currentY = y;
    
    lines.forEach(line => {
        if (currentY > 270) { // Si se acerca al final de la página
            doc.addPage();
            currentY = 20; // Volver al margen superior
        }
        doc.text(line, x, currentY);
        currentY += lineHeight;
    });
    
    return currentY;
}
    </script>
</body>
</html>