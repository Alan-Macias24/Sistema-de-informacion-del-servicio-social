<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Servicio Social - Reporte Mensual</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: linear-gradient(135deg, #1a3a8f 0%, #2c5aa0 100%);
            color: white;
            padding: 20px 0;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
        }

        .logo {
            display: flex;
            align-items: center;
        }

        .logo img {
            height: 60px;
            margin-right: 15px;
        }

        .logo h1 {
            font-size: 1.8rem;
            font-weight: 600;
        }

        .user-info {
            text-align: right;
        }

        .user-info p {
            margin-bottom: 5px;
        }

        .info-cards {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .info-card {
            background: #f8f9fa;
            border: 2px solid #1a3a8f;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .info-card h3 {
            color: #1a3a8f;
            margin-bottom: 15px;
            font-size: 1.2rem;
            border-bottom: 2px solid #1a3a8f;
            padding-bottom: 8px;
        }

        .info-item {
            margin-bottom: 8px;
            display: flex;
        }

        .info-label {
            font-weight: bold;
            color: #333;
            min-width: 120px;
            font-size: 0.9rem;
        }

        .info-value {
            color: #666;
            flex: 1;
            font-size: 0.9rem;
        }

        .report-form {
            background-color: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            margin-bottom: 30px;
        }

        .form-title {
            color: #1a3a8f;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #eaeaea;
            font-size: 1.8rem;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-row {
            display: flex;
            flex-wrap: wrap;
            margin: 0 -10px;
        }

        .form-col {
            flex: 1;
            padding: 0 10px;
            min-width: 250px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #444;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            transition: border 0.3s;
        }

        input:focus, select:focus, textarea:focus {
            border-color: #1a3a8f;
            outline: none;
            box-shadow: 0 0 0 2px rgba(26, 58, 143, 0.2);
        }

        textarea {
            min-height: 120px;
            resize: vertical;
        }

        .section-title {
            font-size: 1.4rem;
            color: #1a3a8f;
            margin: 30px 0 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eaeaea;
        }

        .percentage-inputs {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }

        .percentage-input {
            flex: 1;
            min-width: 200px;
        }

        .percentage-input input {
            text-align: center;
        }

        .signature-section {
            background-color: #f9fafc;
            border: 1px dashed #ccc;
            border-radius: 8px;
            padding: 25px;
            margin-top: 40px;
        }

        .signature-title {
            font-size: 1.3rem;
            color: #1a3a8f;
            margin-bottom: 30px;
            text-align: center;
        }

        .signature-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            gap: 30px;
        }

        .signature-box {
            flex: 1;
            min-width: 280px;
            text-align: center;
        }

        .signature-line {
            height: 2px;
            background-color: #333;
            margin: 60px 0 5px;
            position: relative;
        }

        .signature-name {
            font-weight: 600;
            margin-bottom: 5px;
            color: #444;
            font-size: 1.1rem;
            text-transform: uppercase;
        }

        .signature-role {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 10px;
        }

        .signature-person {
            color: #333;
            font-size: 0.95rem;
            margin-top: 10px;
            font-weight: 500;
            min-height: 20px;
        }

        .signature-instruction {
            color: #888;
            font-size: 0.8rem;
            font-style: italic;
            margin-top: 5px;
        }

        .print-notice {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 6px;
            padding: 15px;
            margin-top: 20px;
            text-align: center;
            color: #856404;
        }

        .print-notice h4 {
            margin-bottom: 10px;
            color: #1a3a8f;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background-color: #1a3a8f;
            color: white;
        }

        .btn-primary:hover {
            background-color: #152c6e;
        }

        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #5a6268;
        }

        .btn-print {
            background-color: #28a745;
            color: white;
        }

        .btn-print:hover {
            background-color: #218838;
        }

        .form-actions {
            display: flex;
            justify-content: space-between;
            gap: 15px;
            margin-top: 30px;
        }

        footer {
            text-align: center;
            margin-top: 40px;
            padding: 20px;
            color: #666;
            font-size: 0.9rem;
            border-top: 1px solid #eaeaea;
        }

        .type-selector {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
        }

        .type-btn {
            flex: 1;
            padding: 20px;
            border: 2px solid #1a3a8f;
            border-radius: 10px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .type-btn:hover {
            background: #f0f8ff;
            transform: translateY(-2px);
        }

        .type-btn.active {
            background: #1a3a8f;
            color: white;
        }

        .type-btn h3 {
            margin-bottom: 10px;
        }

        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
            }
            
            .form-col {
                width: 100%;
            }
            
            .signature-container {
                flex-direction: column;
            }
            
            .header-content {
                flex-direction: column;
                text-align: center;
            }
            
            .user-info {
                text-align: center;
                margin-top: 15px;
            }
            
            .form-actions {
                flex-direction: column;
            }
            
            .type-selector {
                flex-direction: column;
            }
            
            .info-cards {
                grid-template-columns: 1fr;
            }
        }

        @media print {
            .no-print {
                display: none;
            }
            
            .signature-section {
                border: 2px solid #333;
                page-break-inside: avoid;
            }
            
            .signature-line {
                background-color: #000;
            }
            
            .print-notice {
                display: none;
            }
            
            .signature-person {
                font-weight: bold;
            }
            
            .info-cards {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-content">
                <div class="logo">
                    <div style="width: 60px; height: 60px; background-color: #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; color: #1a3a8f;">UDG</div>
                    <h1>Sistema de Servicio Social</h1>
                </div>
                <div class="user-info">
                    <p><strong id="userName">Cargando...</strong></p>
                    <p id="userInfo">Cargando informaci√≥n...</p>
                </div>
            </div>
        </header>

        <main>
            <!-- Selector de tipo de reporte -->
            <div class="type-selector no-print">
                <div class="type-btn active" onclick="selectReportType('mensual')">
                    <h3>üìÖ Reporte Mensual</h3>
                    <p>Reporte de actividades del mes</p>
                </div>
                <div class="type-btn" id="finalReportBtn" onclick="selectReportType('final')">
                    <h3>üéì Reporte Final</h3>
                    <p>Reporte de conclusi√≥n del servicio social</p>
                </div>
            </div>

            <!-- Recuadros informativos -->
            <div class="info-cards no-print">
                <div class="info-card">
                    <h3>üë§ Informaci√≥n del Prestador</h3>
                    <div class="info-item">
                        <span class="info-label">Nombre:</span>
                        <span class="info-value" id="prestadorNombre">Cargando...</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">C√≥digo UDG:</span>
                        <span class="info-value" id="prestadorCodigo">Cargando...</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Carrera:</span>
                        <span class="info-value" id="prestadorCarrera">Cargando...</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Semestre:</span>
                        <span class="info-value" id="prestadorSemestre">Cargando...</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Cr√©ditos:</span>
                        <span class="info-value" id="prestadorCreditos">Cargando...</span>
                    </div>
                </div>

                <div class="info-card">
                    <h3>üè¢ Informaci√≥n de la Dependencia</h3>
                    <div class="info-item">
                        <span class="info-label">Organizaci√≥n:</span>
                        <span class="info-value" id="dependenciaOrganizacion">Cargando...</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Departamento:</span>
                        <span class="info-value" id="dependenciaDepartamento">Cargando...</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Plaza:</span>
                        <span class="info-value" id="dependenciaPlaza">Cargando...</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Receptor:</span>
                        <span class="info-value" id="dependenciaReceptor">Cargando...</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Horas Acumuladas:</span>
                        <span class="info-value" id="dependenciaHoras">Cargando...</span>
                    </div>
                </div>
            </div>

            <div class="report-form" id="mensualForm">
                <h2 class="form-title">Reporte Mensual de Servicio Social</h2>
                
                <form id="reportForm">
                    <!-- Informaci√≥n b√°sica del reporte -->
                    <div class="form-group">
                        <div class="form-row">
                            <div class="form-col">
                                <label for="elaborationDate">Fecha de Elaboraci√≥n</label>
                                <input type="date" id="elaborationDate" name="elaborationDate" required>
                            </div>
                            <div class="form-col">
                                <label for="turn">Turno</label>
                                <select id="turn" name="turn" required>
                                    <option value="">Seleccione turno</option>
                                    <option value="matutino">Matutino</option>
                                    <option value="vespertino">Vespertino</option>
                                    <option value="mixto">Mixto</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Periodo del reporte -->
                    <div class="form-group">
                        <div class="form-row">
                            <div class="form-col">
                                <label for="periodStart">Periodo Inicio</label>
                                <input type="date" id="periodStart" name="periodStart" required>
                            </div>
                            <div class="form-col">
                                <label for="periodEnd">Periodo Fin</label>
                                <input type="date" id="periodEnd" name="periodEnd" required>
                            </div>
                            <div class="form-col">
                                <label for="hoursReported">Horas Reportadas</label>
                                <input type="number" id="hoursReported" name="hoursReported" step="0.5" min="0" required>
                            </div>
                        </div>
                    </div>

                    <!-- Actividades realizadas -->
                    <h3 class="section-title">Actividades Realizadas</h3>
                    <div class="form-group">
                        <label for="activities">Descripci√≥n de Actividades</label>
                        <textarea id="activities" name="activities" placeholder="Describa detalladamente las actividades realizadas durante el periodo..." required></textarea>
                    </div>

                    <!-- Logros, dificultades y aprendizajes -->
                    <div class="form-group">
                        <div class="form-row">
                            <div class="form-col">
                                <label for="achievements">Logros Alcanzados</label>
                                <textarea id="achievements" name="achievements" placeholder="Describa los logros alcanzados..."></textarea>
                            </div>
                            <div class="form-col">
                                <label for="difficulties">Dificultades Encontradas</label>
                                <textarea id="difficulties" name="difficulties" placeholder="Describa las dificultades encontradas..."></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="learnings">Aprendizajes Obtenidos</label>
                        <textarea id="learnings" name="learnings" placeholder="Describa los aprendizajes obtenidos durante el periodo..."></textarea>
                    </div>

                    <!-- Evaluaci√≥n del programa -->
                    <h3 class="section-title">Evaluaci√≥n del Programa</h3>
                    <div class="form-group">
                        <div class="form-row">
                            <div class="form-col">
                                <label for="expectations">¬øCumpli√≥ con sus expectativas el programa?</label>
                                <select id="expectations" name="expectations" required>
                                    <option value="">Seleccione una opci√≥n</option>
                                    <option value="Si">S√≠</option>
                                    <option value="No">No</option>
                                </select>
                            </div>
                            <div class="form-col">
                                <label for="satisfactory">¬øCumpli√≥ satisfactoriamente con las actividades?</label>
                                <select id="satisfactory" name="satisfactory" required>
                                    <option value="">Seleccione una opci√≥n</option>
                                    <option value="Si">S√≠</option>
                                    <option value="No">No</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Porcentajes de aprovechamiento -->
                    <div class="form-group">
                        <label>Porcentaje de Aprovechamiento (%)</label>
                        <div class="percentage-inputs">
                            <div class="percentage-input">
                                <label for="knowledgePercentage">Conocimientos</label>
                                <input type="number" id="knowledgePercentage" name="knowledgePercentage" min="0" max="100" placeholder="0-100">
                            </div>
                            <div class="percentage-input">
                                <label for="experiencePercentage">Experiencias</label>
                                <input type="number" id="experiencePercentage" name="experiencePercentage" min="0" max="100" placeholder="0-100">
                            </div>
                            <div class="percentage-input">
                                <label for="professionalPercentage">Profesionales</label>
                                <input type="number" id="professionalPercentage" name="professionalPercentage" min="0" max="100" placeholder="0-100">
                            </div>
                            <div class="percentage-input">
                                <label for="skillsPercentage">Habilidades</label>
                                <input type="number" id="skillsPercentage" name="skillsPercentage" min="0" max="100" placeholder="0-100">
                            </div>
                        </div>
                    </div>

                    <!-- Aportaciones a la instituci√≥n -->
                    <div class="form-group">
                        <label for="contributions">Aportaciones a la Instituci√≥n</label>
                        <textarea id="contributions" name="contributions" placeholder="Describa las aportaciones realizadas a la instituci√≥n..."></textarea>
                    </div>

                    <!-- Apartado de firmas para documento f√≠sico -->
                    <div class="signature-section">
                        <h3 class="signature-title">Validaci√≥n del Reporte</h3>
                        <p class="signature-instruction">* Este documento deber√° ser impreso para obtener las firmas correspondientes</p>
                        
                        <div class="signature-container">
                            <!-- Firma del prestador -->
                            <div class="signature-box">
                                <div class="signature-name">PRESTADOR DE SERVICIO SOCIAL</div>
                                <div class="signature-role">(Estudiante)</div>
                                <div class="signature-line"></div>
                                <div class="signature-person" id="studentSignature"></div>
                                <div class="signature-instruction">Firma</div>
                            </div>

                            <!-- Firma del receptor -->
                            <div class="signature-box">
                                <div class="signature-name">RECEPTOR DEL SERVICIO SOCIAL</div>
                                <div class="signature-role">(Responsable en la dependencia)</div>
                                <div class="signature-line"></div>
                                <div class="signature-person" id="receptorSignature"></div>
                                <div class="signature-instruction">Firma</div>
                            </div>

                            <!-- Firma del coordinador -->
                            <div class="signature-box">
                                <div class="signature-name">COORDINADOR DE SERVICIO SOCIAL</div>
                                <div class="signature-role">(Responsable acad√©mico)</div>
                                <div class="signature-line"></div>
                                <div class="signature-person" id="coordinatorSignature"></div>
                                <div class="signature-instruction">Firma</div>
                            </div>
                        </div>

                        <div class="print-notice">
                            <h4>‚ö†Ô∏è Importante</h4>
                            <p>Despu√©s de llenar el formulario, imprima este documento para obtener las firmas f√≠sicas requeridas.</p>
                            <p>El documento firmado deber√° ser escaneado y subido al sistema para su validaci√≥n final.</p>
                        </div>
                    </div>

                    <!-- Botones de acci√≥n -->
                    <div class="form-actions no-print">
                        <div>
                            <button type="button" class="btn btn-secondary" onclick="saveAsDraft()">Guardar Borrador</button>
                            <button type="button" class="btn btn-print" onclick="generatePDF('mensual')">Generar PDF</button>
                        </div>
                        <button type="submit" class="btn btn-primary">Enviar Reporte</button>
                    </div>
                </form>
            </div>
        </main>

        <footer class="no-print">
            <p>Centro Universitario de la Ci√©nega - Universidad de Guadalajara</p>
            <p>Sistema de Servicio Social &copy; 2025</p>
        </footer>
    </div>

    <!-- Incluir jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <script>
        let usuario = null;
        let asignacion = null;
        let reportType = 'mensual';
        let prestadorInfo = null;
        let dependenciaInfo = null;

        document.addEventListener('DOMContentLoaded', function() {
            usuario = JSON.parse(localStorage.getItem('usuario'));
            if (!usuario) {
                window.location.href = 'login.html';
                return;
            }

            loadUserInfo();
            loadAsignacionInfo();
            checkFinalReportEligibility();
            setupDefaultDates();
            loadPrestadorInfo();
        });

        function loadUserInfo() {
            document.getElementById('userName').textContent = `${usuario.nombre} ${usuario.apellido_paterno}`;
            document.getElementById('userInfo').textContent = `${usuario.codigo_udg} | ${usuario.carrera || 'Carrera no especificada'}`;
            document.getElementById('studentSignature').textContent = `${usuario.nombre} ${usuario.apellido_paterno} ${usuario.apellido_materno || ''}`;
        }

        async function loadPrestadorInfo() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`http://localhost:3000/perfil/${usuario.codigo_udg}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                
                if (data.status === 'ok') {
                    prestadorInfo = data.perfil;
                    updatePrestadorInfo();
                }
            } catch (error) {
                console.error('Error cargando informaci√≥n del prestador:', error);
            }
        }

        function updatePrestadorInfo() {
            if (prestadorInfo) {
                document.getElementById('prestadorNombre').textContent = 
                    `${prestadorInfo.nombre} ${prestadorInfo.apellido_paterno} ${prestadorInfo.apellido_materno || ''}`;
                document.getElementById('prestadorCodigo').textContent = prestadorInfo.codigo_udg;
                document.getElementById('prestadorCarrera').textContent = prestadorInfo.carrera || 'No especificada';
                document.getElementById('prestadorSemestre').textContent = prestadorInfo.semestre || 'No especificado';
                document.getElementById('prestadorCreditos').textContent = 
                    `${prestadorInfo.creditos_aprobados || 0} (${prestadorInfo.porcentaje_creditos || 0}%)`;
            }
        }

       // En la funci√≥n loadAsignacionInfo de ambos archivos, mejorar la obtenci√≥n del nombre del receptor
async function loadAsignacionInfo() {
    try {
        const token = localStorage.getItem('token');
        const response = await fetch('http://localhost:3000/asignacion-activa', {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        const data = await response.json();
        
        if (data.status === 'ok' && data.asignacion) {
            asignacion = data.asignacion;
            dependenciaInfo = data.asignacion;
            updateDependenciaInfo();
            
            // Obtener nombre completo del receptor
            const receptorNombreCompleto = 
                `${asignacion.receptor_nombre || ''} ${asignacion.receptor_apellido_paterno || ''} ${asignacion.receptor_apellido_materno || ''}`.trim();
            
            document.getElementById('receptorSignature').textContent = receptorNombreCompleto || 'No especificado';
            document.getElementById('coordinatorSignature').textContent = 'Coordinador de Servicio Social';
            
            // Actualizar tambi√©n en los recuadros informativos
            document.getElementById('dependenciaReceptor').textContent = receptorNombreCompleto || 'No especificado';
            
        } else {
            document.getElementById('dependenciaOrganizacion').textContent = 'Sin asignaci√≥n activa';
            document.getElementById('dependenciaDepartamento').textContent = 'N/A';
            document.getElementById('dependenciaPlaza').textContent = 'N/A';
            document.getElementById('dependenciaReceptor').textContent = 'N/A';
            document.getElementById('dependenciaHoras').textContent = 'N/A';
        }
    } catch (error) {
        console.error('Error cargando informaci√≥n de asignaci√≥n:', error);
    }
}

        function updateDependenciaInfo() {
            if (dependenciaInfo) {
                document.getElementById('dependenciaOrganizacion').textContent = dependenciaInfo.organizacion || 'No especificada';
                document.getElementById('dependenciaDepartamento').textContent = dependenciaInfo.departamento || 'No especificado';
                document.getElementById('dependenciaPlaza').textContent = dependenciaInfo.plaza_titulo || 'No especificada';
                document.getElementById('dependenciaReceptor').textContent = dependenciaInfo.receptor_nombre || 'No especificado';
                document.getElementById('dependenciaHoras').textContent = 
                    `${dependenciaInfo.horas_acumuladas || 0} / ${dependenciaInfo.horas_requeridas || 480} horas`;
            }
        }

        async function checkFinalReportEligibility() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`http://localhost:3000/estadisticas/${usuario.codigo_udg}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                
                if (data.status === 'ok') {
                    const stats = data.estadisticas;
                    const finalReportBtn = document.getElementById('finalReportBtn');
                    
                    if (stats.horas_acumuladas >= stats.horas_requeridas) {
                        finalReportBtn.style.opacity = '1';
                        finalReportBtn.style.cursor = 'pointer';
                    } else {
                        finalReportBtn.style.opacity = '0.5';
                        finalReportBtn.style.cursor = 'not-allowed';
                        finalReportBtn.onclick = null;
                        finalReportBtn.title = `Completa ${stats.horas_requeridas - stats.horas_acumuladas} horas m√°s para acceder al reporte final`;
                    }
                }
            } catch (error) {
                console.error('Error verificando elegibilidad:', error);
            }
        }

        function setupDefaultDates() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('elaborationDate').value = today;

            const periodEnd = new Date();
            const periodStart = new Date();
            periodStart.setMonth(periodStart.getMonth() - 1);
            
            document.getElementById('periodStart').value = periodStart.toISOString().split('T')[0];
            document.getElementById('periodEnd').value = periodEnd.toISOString().split('T')[0];
        }

        function selectReportType(type) {
            reportType = type;
            
            document.querySelectorAll('.type-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.closest('.type-btn').classList.add('active');
            
            if (type === 'final') {
                window.location.href = 'crear_reporte_final.html';
            }
        }

        function validateForm() {
            const hoursReported = document.getElementById('hoursReported').value;
            const activities = document.getElementById('activities').value;
            
            if (!hoursReported || hoursReported <= 0) {
                alert('Por favor, ingrese un n√∫mero v√°lido de horas reportadas.');
                return false;
            }

            if (!activities.trim()) {
                alert('Por favor, describa las actividades realizadas.');
                return false;
            }

            return true;
        }

        async function saveAsDraft() {
            if (!validateForm()) return;

            const formData = {
                tipo: 'mensual',
                periodo_inicio: document.getElementById('periodStart').value,
                periodo_fin: document.getElementById('periodEnd').value,
                actividades_realizadas: document.getElementById('activities').value,
                logros: document.getElementById('achievements').value,
                dificultades: document.getElementById('difficulties').value,
                aprendizajes: document.getElementById('learnings').value,
                horas_reportadas: parseFloat(document.getElementById('hoursReported').value),
                estado: 'borrador',
                fecha_entrega: new Date().toISOString(),
                turno: document.getElementById('turn').value,
                fecha_elaboracion: document.getElementById('elaborationDate').value,
                expectativas_programa: document.getElementById('expectations').value,
                porcentaje_conocimientos: parseInt(document.getElementById('knowledgePercentage').value) || 0,
                porcentaje_experiencias: parseInt(document.getElementById('experiencePercentage').value) || 0,
                porcentaje_profesionales: parseInt(document.getElementById('professionalPercentage').value) || 0,
                porcentaje_habilidades: parseInt(document.getElementById('skillsPercentage').value) || 0,
                aportaciones_institucion: document.getElementById('contributions').value,
                cumplimiento_satisfactorio: document.getElementById('satisfactory').value
            };

            try {
                const token = localStorage.getItem('token');
                const response = await fetch('http://localhost:3000/reportes', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();
                
                if (result.status === 'ok') {
                    alert('Reporte guardado exitosamente como borrador.');
                } else {
                    alert('Error: ' + result.message);
                }
            } catch (error) {
                console.error('Error guardando reporte:', error);
                alert('Error al guardar el reporte. Intente nuevamente.');
            }
        }

        // Reemplazar la funci√≥n generatePDF en crear_reporte.html
function generatePDF(type) {
    if (!validateForm()) return;

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    // Configurar m√°rgenes y estilo
    const margin = 20;
    let yPosition = margin;
    
    // T√≠tulo principal
    doc.setFontSize(16);
    doc.setFont(undefined, 'bold');
    doc.text('REPORTE MENSUAL DE SERVICIO SOCIAL', 105, yPosition, { align: 'center' });
    yPosition += 15;
    
    // Informaci√≥n de la universidad
    doc.setFontSize(10);
    doc.setFont(undefined, 'normal');
    doc.text('UNIVERSIDAD DE GUADALAJARA', 105, yPosition, { align: 'center' });
    yPosition += 5;
    doc.text('CENTRO UNIVERSITARIO DE LA CI√âNEGA', 105, yPosition, { align: 'center' });
    yPosition += 5;
    doc.text('UNIDAD DE SERVICIO SOCIAL', 105, yPosition, { align: 'center' });
    yPosition += 15;
    
    // L√≠nea separadora
    doc.setDrawColor(0);
    doc.setLineWidth(0.5);
    doc.line(margin, yPosition, 190, yPosition);
    yPosition += 10;
    
    // Informaci√≥n del prestador
    doc.setFontSize(12);
    doc.setFont(undefined, 'bold');
    doc.text('INFORMACI√ìN DEL PRESTADOR', margin, yPosition);
    yPosition += 8;
    
    doc.setFontSize(10);
    doc.setFont(undefined, 'normal');
    doc.text(`Nombre: ${usuario.nombre} ${usuario.apellido_paterno} ${usuario.apellido_materno || ''}`, margin, yPosition);
    yPosition += 6;
    doc.text(`C√≥digo UDG: ${usuario.codigo_udg}`, margin, yPosition);
    yPosition += 6;
    doc.text(`Carrera: ${usuario.carrera || 'No especificada'}`, margin, yPosition);
    yPosition += 6;
    doc.text(`Periodo: ${document.getElementById('periodStart').value} a ${document.getElementById('periodEnd').value}`, margin, yPosition);
    yPosition += 6;
    doc.text(`Horas reportadas: ${document.getElementById('hoursReported').value} horas`, margin, yPosition);
    yPosition += 10;
    
    // Informaci√≥n de la dependencia
    if (dependenciaInfo) {
        doc.setFontSize(12);
        doc.setFont(undefined, 'bold');
        doc.text('INFORMACI√ìN DE LA DEPENDENCIA', margin, yPosition);
        yPosition += 8;
        
        doc.setFontSize(10);
        doc.setFont(undefined, 'normal');
        doc.text(`Organizaci√≥n: ${dependenciaInfo.organizacion || 'No especificada'}`, margin, yPosition);
        yPosition += 6;
        doc.text(`Departamento: ${dependenciaInfo.departamento || 'No especificado'}`, margin, yPosition);
        yPosition += 6;
        doc.text(`Plaza: ${dependenciaInfo.plaza_titulo || 'No especificada'}`, margin, yPosition);
        yPosition += 6;
        doc.text(`Receptor: ${dependenciaInfo.receptor_nombre || 'No especificado'}`, margin, yPosition);
        yPosition += 10;
    }
    
    // Actividades realizadas
    doc.setFontSize(12);
    doc.setFont(undefined, 'bold');
    doc.text('ACTIVIDADES REALIZADAS', margin, yPosition);
    yPosition += 8;
    
    doc.setFontSize(10);
    doc.setFont(undefined, 'normal');
    const activities = doc.splitTextToSize(document.getElementById('activities').value, 170);
    activities.forEach(line => {
        if (yPosition > 270) {
            doc.addPage();
            yPosition = margin;
        }
        doc.text(line, margin, yPosition);
        yPosition += 6;
    });
    yPosition += 5;
    
    // Logros alcanzados
    const achievements = document.getElementById('achievements').value;
    if (achievements.trim()) {
        if (yPosition > 250) {
            doc.addPage();
            yPosition = margin;
        }
        
        doc.setFontSize(12);
        doc.setFont(undefined, 'bold');
        doc.text('LOGROS ALCANZADOS', margin, yPosition);
        yPosition += 8;
        
        doc.setFontSize(10);
        doc.setFont(undefined, 'normal');
        const achievementsText = doc.splitTextToSize(achievements, 170);
        achievementsText.forEach(line => {
            if (yPosition > 270) {
                doc.addPage();
                yPosition = margin;
            }
            doc.text(line, margin, yPosition);
            yPosition += 6;
        });
        yPosition += 5;
    }
    
    // Aprendizajes obtenidos
    const learnings = document.getElementById('learnings').value;
    if (learnings.trim()) {
        if (yPosition > 250) {
            doc.addPage();
            yPosition = margin;
        }
        
        doc.setFontSize(12);
        doc.setFont(undefined, 'bold');
        doc.text('APRENDIZAJES OBTENIDOS', margin, yPosition);
        yPosition += 8;
        
        doc.setFontSize(10);
        doc.setFont(undefined, 'normal');
        const learningsText = doc.splitTextToSize(learnings, 170);
        learningsText.forEach(line => {
            if (yPosition > 270) {
                doc.addPage();
                yPosition = margin;
            }
            doc.text(line, margin, yPosition);
            yPosition += 6;
        });
        yPosition += 5;
    }
    
    // Firmas
    if (yPosition > 200) {
        doc.addPage();
        yPosition = margin;
    }
    
    doc.setFontSize(12);
    doc.setFont(undefined, 'bold');
    doc.text('VALIDACI√ìN DEL REPORTE', 105, yPosition, { align: 'center' });
    yPosition += 15;
    
    // Firma del prestador
    doc.setFontSize(10);
    doc.setFont(undefined, 'bold');
    doc.text('PRESTADOR DE SERVICIO SOCIAL', margin, yPosition);
    yPosition += 5;
    doc.setFont(undefined, 'normal');
    doc.text('(Estudiante)', margin, yPosition);
    yPosition += 15;
    doc.line(margin, yPosition, margin + 50, yPosition);
    yPosition += 8;
    doc.text(`${usuario.nombre} ${usuario.apellido_paterno} ${usuario.apellido_materno || ''}`, margin, yPosition);
    yPosition += 5;
    doc.setFontSize(8);
    doc.text('Firma', margin, yPosition);
    yPosition += 20;
    
    // Firma del receptor
    if (dependenciaInfo && dependenciaInfo.receptor_nombre) {
        doc.setFontSize(10);
        doc.setFont(undefined, 'bold');
        doc.text('RECEPTOR DEL SERVICIO SOCIAL', 70, yPosition);
        yPosition += 5;
        doc.setFont(undefined, 'normal');
        doc.text('(Responsable en la dependencia)', 70, yPosition);
        yPosition += 15;
        doc.line(70, yPosition, 120, yPosition);
        yPosition += 8;
        doc.text(dependenciaInfo.receptor_nombre, 70, yPosition);
        yPosition += 5;
        doc.setFontSize(8);
        doc.text('Firma', 70, yPosition);
        yPosition += 20;
    }
    
    // Firma del coordinador
    doc.setFontSize(10);
    doc.setFont(undefined, 'bold');
    doc.text('COORDINADOR DE SERVICIO SOCIAL', 140, yPosition);
    yPosition += 5;
    doc.setFont(undefined, 'normal');
    doc.text('(Responsable acad√©mico)', 140, yPosition);
    yPosition += 15;
    doc.line(140, yPosition, 190, yPosition);
    yPosition += 8;
    doc.text('Coordinador de Servicio Social', 140, yPosition);
    yPosition += 5;
    doc.setFontSize(8);
    doc.text('Firma', 140, yPosition);
    
    // Guardar PDF
    doc.save(`reporte_mensual_${usuario.codigo_udg}_${new Date().toISOString().split('T')[0]}.pdf`);
}

        document.getElementById('reportForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!validateForm()) return;

            const formData = {
                tipo: 'mensual',
                periodo_inicio: document.getElementById('periodStart').value,
                periodo_fin: document.getElementById('periodEnd').value,
                actividades_realizadas: document.getElementById('activities').value,
                logros: document.getElementById('achievements').value,
                dificultades: document.getElementById('difficulties').value,
                aprendizajes: document.getElementById('learnings').value,
                horas_reportadas: parseFloat(document.getElementById('hoursReported').value),
                estado: 'en_revision',
                fecha_entrega: new Date().toISOString(),
                turno: document.getElementById('turn').value,
                fecha_elaboracion: document.getElementById('elaborationDate').value,
                expectativas_programa: document.getElementById('expectations').value,
                porcentaje_conocimientos: parseInt(document.getElementById('knowledgePercentage').value) || 0,
                porcentaje_experiencias: parseInt(document.getElementById('experiencePercentage').value) || 0,
                porcentaje_profesionales: parseInt(document.getElementById('professionalPercentage').value) || 0,
                porcentaje_habilidades: parseInt(document.getElementById('skillsPercentage').value) || 0,
                aportaciones_institucion: document.getElementById('contributions').value,
                cumplimiento_satisfactorio: document.getElementById('satisfactory').value
            };

            try {
                const token = localStorage.getItem('token');
                const response = await fetch('http://localhost:3000/reportes', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();
                
                if (result.status === 'ok') {
                    alert('Reporte enviado exitosamente para revisi√≥n.');
                    window.location.href = 'mis_reportes.html';
                } else {
                    alert('Error: ' + result.message);
                }
            } catch (error) {
                console.error('Error enviando reporte:', error);
                alert('Error al enviar el reporte. Intente nuevamente.');
            }
        });
        // Agregar esta funci√≥n auxiliar para manejar saltos de p√°gina autom√°ticos
function addTextWithPageBreaks(doc, text, x, y, maxWidth, lineHeight = 6) {
    const lines = doc.splitTextToSize(text, maxWidth);
    let currentY = y;
    
    lines.forEach(line => {
        if (currentY > 270) { // Si se acerca al final de la p√°gina
            doc.addPage();
            currentY = 20; // Volver al margen superior
        }
        doc.text(line, x, currentY);
        currentY += lineHeight;
    });
    
    return currentY;
}
    </script>
</body>
</html>